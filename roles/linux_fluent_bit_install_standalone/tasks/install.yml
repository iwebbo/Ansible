---
# ============================================================================
# INSTALLATION OF FLUENT BIT
# ============================================================================

- name: Install dependencies (Debian/Ubuntu)
  apt:
    name:
      - curl
      - gnupg
      - ca-certificates
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Install dependencies (RedHat/CentOS/Fedora)
  yum:
    name:
      - curl
      - gnupg2
      - ca-certificates
    state: present
  when: ansible_os_family == "RedHat"

# --- DEBIAN/UBUNTU ---
- name: Add Fluent Bit GPG key (Debian/Ubuntu)
  apt_key:
    url: https://packages.fluentbit.io/fluentbit.key
    state: present
  when: ansible_os_family == "Debian"

- name: Add Fluent Bit repository (Debian/Ubuntu)
  apt_repository:
    repo: "deb https://packages.fluentbit.io/{{ ansible_distribution | lower }}/{{ ansible_distribution_release }} {{ ansible_distribution_release }} main"
    state: present
    filename: fluent-bit
  when: ansible_os_family == "Debian"

- name: Install Fluent Bit (Debian/Ubuntu)
  apt:
    name: "fluent-bit{% if fluent_bit_version != 'latest' %}={{ fluent_bit_version }}{% endif %}"
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

# --- REDHAT/CENTOS/FEDORA ---
- name: Add Fluent Bit repository (RedHat/CentOS/Fedora)
  yum_repository:
    name: fluent-bit
    description: Fluent Bit Repository
    baseurl: "https://packages.fluentbit.io/centos/{{ ansible_distribution_major_version }}"
    gpgcheck: yes
    gpgkey: https://packages.fluentbit.io/fluentbit.key
    enabled: yes
  when: ansible_os_family == "RedHat"

- name: Install Fluent Bit (RedHat/CentOS/Fedora)
  yum:
    name: "fluent-bit{% if fluent_bit_version != 'latest' %}-{{ fluent_bit_version }}{% endif %}"
    state: present
  when: ansible_os_family == "RedHat"

- name: Verify Fluent Bit installation
  command: /opt/fluent-bit/bin/fluent-bit --version
  register: fb_version
  changed_when: false

- name: Display Fluent Bit version
  debug:
    msg: "Fluent Bit {{ fb_version.stdout_lines[0] }} installed successfully"
