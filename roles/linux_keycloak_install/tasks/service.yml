---
# tasks/service.yml - TÃ¢ches de gestion du service Keycloak

- name: Install Keycloak systemd service
  template:
    src: keycloak.service.j2
    dest: /etc/systemd/system/keycloak.service
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  tags:
    - service
    - systemd

- name: Ensure Keycloak service is enabled
  systemd:
    name: keycloak
    enabled: yes
    daemon_reload: yes
  tags:
    - service
    - enable

- name: Start Keycloak service
  systemd:
    name: keycloak
    state: started
  register: service_start
  until: service_start is succeeded
  retries: 3
  delay: 10
  tags:
    - service
    - start
    
- name: Ensure Keycloak service is running
  systemd:
    name: keycloak
    state: started
  tags:
    - service
    - start
    
- name: Check if Keycloak is responding
  uri:
    url: "http://localhost:8080/health"
    return_content: yes
    status_code: 200
    timeout: 30
  register: keycloak_health
  until: keycloak_health is succeeded
  retries: 5
  delay: 10
  tags:
    - service
    - verify